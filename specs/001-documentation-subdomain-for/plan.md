# Implementation Plan: Documentation Subdomain for 21.dev

**Branch**: `001-documentation-subdomain-for` | **Date**: 2025-10-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-documentation-subdomain-for/spec.md`

## Summary

Generate combined API documentation for the swift-secp256k1 cryptographic library (targets: P256K and ZKP) and deploy as a static site to docs.21.dev subdomain. Documentation will auto-update via Dependabot PRs and deploy through a Cloudflare Pages project, using the existing websites Package.swift as an umbrella package to access external dependency targets.

**Technical Approach**: Use swift-docc-plugin to generate combined documentation from this repository (umbrella package), targeting swift-secp256k1's modules directly. Deploy via GitHub Actions to a separate Cloudflare Pages project with docs.21.dev custom domain. CI triggers on Package.swift/Package.resolved changes for both PRs (preview) and main branch (production).

## Technical Context

**Language/Version**: Swift 6.1+ (macOS 15+)
**Primary Dependencies**: 
- swift-docc-plugin 1.4.5 (already in Package.swift)
- swift-secp256k1 0.21.1 (external package being documented)
- Swift Package Manager (SPM)

**Storage**: N/A (static site generation only)
**Testing**: swift-testing (for CI workflow validation)
**Target Platform**: GitHub Actions (macOS-15 runners), Cloudflare Pages (static hosting)
**Project Type**: Static documentation site (separate from main 21.dev site)
**Performance Goals**: 
- Documentation generation: <10 minutes
- Site load time: <3 seconds (SC-001)
- Page performance score: 90+ Lighthouse (SC-008)

**Constraints**:
- Zero additional Swift package dependencies beyond approved stack
- Must preserve existing CI workflows for 21.dev site (FR-015)
- Static hosting only (no server-side rendering)
- Public access with no authentication
- 1-day artifact retention matching existing workflow pattern

**Scale/Scope**: 
- 2 targets (P256K, ZKP) from single external package
- ~50-200MB documentation output
- Single repository documentation (multi-repo deferred)

## Constitution Check

*GATE: Must pass before implementation*

### Compliance Status: ✅ PASSING

| Principle | Status | Notes |
|-----------|--------|-------|
| **I. Design System First** | ✅ N/A | Documentation site uses DocC's built-in styling (not DesignSystem) |
| **II. Zero Dependencies** | ✅ PASS | swift-docc-plugin already approved in constitution (FR updated) |
| **III. Test-First Development** | ✅ PASS | Infrastructure-as-Code exemption (v1.1.0): CI workflow validated via PR-based integration testing (T009, T011) per §III IaC alternative quality gates |
| **IV. Static Site Architecture** | ✅ PASS | Pure static HTML/CSS/JS output from DocC (FR-008) |
| **V. Slipstream API Preference** | ✅ N/A | Documentation site uses DocC templates (not Slipstream) |
| **VI. Swift 6 + SPM Standards** | ✅ PASS | Swift 6.1, SPM exclusively, no alternate build systems |

**No violations detected.** This feature adds a documentation subdomain using an already-approved dependency (swift-docc-plugin) within the existing static site architecture.

## Project Structure

### Documentation (this feature)

```
specs/001-documentation-subdomain-for/
├── spec.md                    # Feature specification
├── plan.md                    # This file
├── checklists/
│   └── requirements.md        # Specification quality validation
└── [tasks.md]                 # Generated by /speckit.tasks command
```

### Source Code (repository root)

```
.github/workflows/
├── 21-DEV.yml                 # Existing site workflow (preserved)
├── cloudflare-deployment.yml  # Existing deployment workflow (template)
└── docs-documentation.yml     # NEW: Documentation generation & deployment

Websites/
├── 21-dev/                    # Existing main site output (preserved)
└── docs-21-dev/               # NEW: Documentation output directory

Package.swift                  # Umbrella package (modified to add docs-21-dev target)
Package.resolved               # Dependency versions (existing, updated by Dependabot)
```

**Structure Decision**: This is primarily a CI/CD feature. Changes include: workflow files in `.github/workflows/`, documentation output in `Websites/docs-21-dev/`, and a minimal docs-21-dev executable target in Package.swift (for accessing swift-secp256k1 targets).

## Documentation Generation Command

### Full Command Syntax

```bash
# Extract version from Package.resolved
SECP256K1_VERSION=$(jq -r '.pins[] | select(.identity == "swift-secp256k1") | .state.version' Package.resolved)

swift package \
  --allow-writing-to-directory ./Websites/docs-21-dev \
  generate-documentation \
  --target P256K \
  --target ZKP \
  --enable-experimental-combined-documentation \
  --transform-for-static-hosting \
  --source-service github \
  --source-service-base-url https://github.com/21-DOT-DEV/swift-secp256k1/blob/$SECP256K1_VERSION \
  --checkout-path .build/checkouts/swift-secp256k1 \
  --output-path ./Websites/docs-21-dev
```

### Flag Breakdown

**SPM Permissions**:
- `--allow-writing-to-directory ./Websites/docs-21-dev` - Required sandbox permission

**Core Generation**:
- `--target [name]` - Target P256K and ZKP modules from swift-secp256k1 (FR-001)
- `--enable-experimental-combined-documentation` - Merge both targets into unified site (FR-002)
- `--output-path ./Websites/docs-21-dev` - Write output to deployment directory

**Static Hosting**:
- `--transform-for-static-hosting` - Generate static-compatible HTML (FR-004)

**Source Linking** (FR-005, FR-017, FR-021):
- `--source-service github` - Enable GitHub source links
- `--source-service-base-url https://github.com/21-DOT-DEV/swift-secp256k1/blob/$SECP256K1_VERSION` - Base URL with version from Package.resolved (ensures links point to exact documented version)
- `--checkout-path .build/checkouts/swift-secp256k1` - Path to swift-secp256k1 checkout for accurate source link generation (relative paths from this directory appended to base URL)

**Omitted Flags** (by design):
- `--disable-indexing` - **NOT used** to enable search (discoverability requirement)
- `--symbol-graph-minimum-access-level internal` - **NOT used** for public-only docs (FR-003)
- `--experimental-enable-custom-templates` - **NOT used** initially (Future Considerations)

## GitHub Actions Workflow Design

### Workflow File: `.github/workflows/docs-documentation.yml`

**Triggers**:
```yaml
on:
  pull_request:
    paths:
      - 'Package.swift'
      - 'Package.resolved'
  push:
    branches:
      - main
    paths:
      - 'Package.swift'
      - 'Package.resolved'
  workflow_dispatch:  # Manual trigger option
```

**Rationale**: Path-based triggering (Option A from Q3) catches Dependabot updates and any dependency changes, works consistently for both PRs and main branch pushes.

### Job Structure

**Job 1: `generate-docs`**
- Runs on: `macos-15`
- Swift version: 6.1
- Steps:
  1. Checkout repository
  2. Resolve dependencies (`swift package resolve`)
  3. Extract swift-secp256k1 version from Package.resolved:
     ```bash
     SECP256K1_VERSION=$(jq -r '.pins[] | select(.identity == "swift-secp256k1") | .state.version' Package.resolved)
     echo "SECP256K1_VERSION=$SECP256K1_VERSION" >> $GITHUB_ENV
     ```
  4. Generate documentation (command above, using `$SECP256K1_VERSION`)
  5. Upload artifact (`Websites/docs-21-dev/`, 1-day retention per FR-023)

**Job 2: `deploy-preview`** (PR only)
- Needs: `generate-docs`
- Runs on: `ubuntu-latest`
- Steps:
  1. Download documentation artifact
  2. Deploy to Cloudflare Pages (preview branch)
  3. Post preview URL to PR comments (FR-022)

**Job 3: `deploy-production`** (main branch only)
- Needs: `generate-docs`
- Runs on: `ubuntu-latest`
- Steps:
  1. Download documentation artifact
  2. Deploy to Cloudflare Pages (main branch)
  3. Documentation live at docs.21.dev

### Reusing Existing Cloudflare Workflow Pattern

Leverage `.github/workflows/cloudflare-deployment.yml` structure:
- Same artifact upload/download pattern
- Same Cloudflare Pages action (`cloudflare/pages-action@v1`)
- Same branch-based deployment logic (`preview` vs `main`)
- Adapt for `docs-21-dev` project name

## Cloudflare Pages Configuration

### Project Setup

**Project Name**: `docs-21-dev`
**Custom Domain**: `docs.21.dev` (FR-006, FR-009)
**Build Settings**: 
- Build command: None (pre-built in CI)
- Build output directory: `/` (root of uploaded artifact)
- Root directory: `/`

**Branch Deployments**:
- **Production branch**: `main` → https://docs.21.dev
- **Preview branches**: `preview` → https://[unique-id].docs-21-dev.pages.dev

**Environment Variables**: None required (static site)

**Access Control**: Public (FR-020)

### DNS Configuration

Add CNAME record:
```
docs.21.dev → docs-21-dev.pages.dev
```

## CI/CD Pipeline Flow

### Pull Request Flow

1. **Trigger**: Dependabot opens PR updating `Package.resolved` with new swift-secp256k1 version
2. **Generate**: `generate-docs` job runs documentation build
   - Success: Documentation generated successfully
   - Failure: PR check fails with error logs (FR-012, FR-019)
3. **Deploy Preview**: `deploy-preview` job uploads to Cloudflare preview URL
4. **Comment**: Bot posts preview URL to PR (FR-022)
5. **Review**: Maintainer reviews preview docs before merge
6. **Merge**: PR approved and merged to main

### Main Branch Flow

1. **Trigger**: PR merge pushes to main with Package.swift/Package.resolved changes
2. **Generate**: `generate-docs` job runs documentation build (using Package.resolved)
3. **Deploy Production**: `deploy-production` job uploads to Cloudflare main branch
4. **Live**: Documentation available at docs.21.dev within 15 minutes (SC-004)

### Error Handling

**Documentation Generation Failure**:
- CI job fails with exit code
- Clear error message in logs (FR-019, SC-007)
- GitHub status check fails on PR
- No deployment occurs

**Cloudflare Deployment Failure**:
- Retry deployment (cloudflare/pages-action has built-in retries)
- If retries exhausted: workflow fails
- GitHub notification to maintainers via status check failure (clarification Q2)
- No email/Slack/PagerDuty (just GitHub notifications)

## Output Directory Structure

```
Websites/docs-21-dev/
├── index.html                 # Landing page (DocC auto-generated)
├── documentation/
│   ├── p256k/                 # P256K target docs
│   └── zkp/                   # ZKP target docs
├── data/
│   └── documentation/         # Symbol graph data
├── css/                       # DocC default styles
├── js/                        # DocC search and navigation
└── images/                    # Icons and assets
```

**Note**: Exact structure determined by DocC with `--enable-experimental-combined-documentation` flag. Structure shown above is expected output based on 2 targets; experimental flag may produce variations.

## Testing Strategy

### Pre-Merge Testing (PR CI)

1. **Documentation Build Test**: Verify `swift package generate-documentation` completes without errors
2. **Output Validation**: Check that `Websites/docs-21-dev/` contains expected files
3. **Preview Deployment Test**: Verify Cloudflare preview deployment succeeds
4. **Link Test**: Basic smoke test that index.html loads in preview

### Post-Merge Validation (Production)

1. **Production Deployment**: Verify main branch deployment to docs.21.dev
2. **Manual Verification** (first deployment):
   - Visit docs.21.dev
   - Verify both targets (P256K, ZKP) are documented (SC-002)
   - Test search functionality
   - Click source code links → verify GitHub navigation (SC-003)
   - Run Lighthouse performance test (SC-008)

### Ongoing Validation

- **Dependabot PR CI**: Automatic test build on every swift-secp256k1 update
- **Preview URL Review**: Manual review of preview deployment before merge
- **Post-Deploy Smoke Test**: Automated check that docs.21.dev returns 200 OK

## Success Metrics

**From Spec Success Criteria** (mapped to implementation):

- **SC-001**: Load time <3 seconds → Achieved via static hosting + Cloudflare CDN
- **SC-002**: Both targets documented → Verified by `--target` flags in command
- **SC-003**: 100% source links work → Verified by `--source-service` flags
- **SC-004**: Deploy within 15 minutes → CI job timeout + Cloudflare deployment time
- **SC-005**: Test builds complete in 10 minutes → macos-15 runner performance
- **SC-006**: Zero manual intervention → Fully automated CI/CD
- **SC-007**: Clear error messages → DocC output + workflow logging
- **SC-008**: Lighthouse 90+ → Static site + optimized DocC output

## Edge Cases & Handling

**Edge Case 1**: swift-secp256k1 removes a public API
- **Impact**: Documentation generation should succeed (deprecated symbols noted)
- **Handling**: DocC handles removed symbols gracefully, no special action needed

**Edge Case 2**: Malformed documentation comments in swift-secp256k1
- **Impact**: DocC generation may fail
- **Handling**: CI fails PR with error log pointing to problem (user reports to swift-secp256k1 maintainers)

**Edge Case 3**: GitHub repository unavailable during generation
- **Impact**: Source links may fail
- **Handling**: DocC may generate docs without source links (warning logged) or fail if required

**Edge Case 4**: Cloudflare deployment failure
- **Impact**: Docs not updated despite successful generation
- **Handling**: GitHub Actions retries via cloudflare/pages-action, manual retry via workflow_dispatch if needed

**Edge Case 5**: Multiple simultaneous Dependabot PRs
- **Impact**: Multiple workflows run concurrently
- **Handling**: Path filter ensures only swift-secp256k1 changes trigger docs workflow, others ignored

**Edge Case 6**: DocC combined documentation flag behavior unknown
- **Impact**: Landing page structure may differ from expectations
- **Handling**: Accept initial output, enhance with custom landing page if needed (Future Considerations)

**Edge Case 7**: Package.resolved format changes or version extraction fails
- **Impact**: Source links may point to wrong version or break entirely
- **Handling**: CI validation step checks that `$SECP256K1_VERSION` is non-empty before running documentation generation; fail fast with clear error if extraction fails

## Future Enhancements

**Phase 1 Complete** (this plan):
- Single-repository documentation (swift-secp256k1)
- DocC default templates and styling
- Automated CI/CD pipeline

**Phase 2 Considerations** (deferred):
- **Multi-Repository Documentation**: When documenting packages from different repos, implement one of:
  - Separate Cloudflare Pages projects per package repo
  - Custom DocC templates for per-target source linking
  - Post-process HTML to rewrite source links
  
- **Custom Landing Page**: If DocC's auto-generated landing page is insufficient:
  - Design custom index.html with branding
  - Curated navigation and feature highlights
  - Integration with main 21.dev site navigation

- **Custom DocC Templates**: For advanced styling/branding:
  - Enable `--experimental-enable-custom-templates`
  - Create custom CSS and template overrides
  - Maintain consistency with 21.dev design

- **Documentation Metrics**: Track documentation usage:
  - Cloudflare Analytics for page views
  - Popular search queries
  - User retention metrics

## Implementation Checklist

- [ ] Create `.github/workflows/docs-documentation.yml` workflow file
- [ ] Configure Cloudflare Pages project `docs-21-dev`
- [ ] Add custom domain `docs.21.dev` to Cloudflare Pages
- [ ] Configure DNS CNAME: `docs.21.dev → docs-21-dev.pages.dev`
- [ ] Test documentation generation locally with full command
- [ ] Push workflow to feature branch and test CI run
- [ ] Test preview deployment on feature branch PR
- [ ] Merge to main and verify production deployment
- [ ] Verify docs.21.dev loads and displays both targets (P256K, ZKP)
- [ ] Run Lighthouse performance test
- [ ] Test source code links to GitHub
- [ ] Test search functionality
- [ ] Create test Dependabot PR to verify automated updates
- [ ] Document workflow in repository README (if needed)

## Dependencies & Prerequisites

**Existing**:
- swift-docc-plugin 1.4.5 in Package.swift ✅
- Cloudflare Pages account with capacity ✅
- GitHub Actions enabled ✅
- Dependabot configured ✅
- Package.resolved committed to repository ✅

**New Requirements**:
- Cloudflare API token in GitHub Secrets (reuse existing `cloudflare-api-token`)
- Cloudflare account ID in GitHub Secrets (reuse existing `cloudflare-account-id`)
- New Cloudflare Pages project `docs-21-dev` (to be created)
- DNS access to add `docs.21.dev` CNAME (one-time setup)

**No New Dependencies**: This feature requires zero additional Swift packages beyond the already-approved swift-docc-plugin. ✅ Constitution compliant.
