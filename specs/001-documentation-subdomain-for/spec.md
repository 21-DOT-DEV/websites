# Feature Specification: Documentation Subdomain for 21.dev

**Feature Branch**: `001-documentation-subdomain-for`  
**Created**: 2025-10-15  
**Status**: Draft  
**Input**: User description: "Documentation subdomain for 21.dev website using swift-docc-plugin to generate combined documentation for swift-secp256k1 package targets"

## Clarifications

### Session 2025-10-15

- Q: Who can access the documentation at docs.21.dev? → A: Public - Anyone can access without authentication (standard for open-source library docs)
- Q: How should CI alert maintainers when deployment fails after retries? → A: GitHub notifications only - Failed CI shows in PR status checks and GitHub notification inbox
- Q: Should the documentation landing page be auto-generated by DocC or custom-designed? → A: DocC auto-generated - Use whatever DocC produces with experimental combined documentation flag, enhance with custom landing page in future if needed
- Q: How should documentation artifacts be retained and previewed? → A: Use existing Cloudflare deployment pattern - 1 day retention for build artifacts passed between jobs, preview via Cloudflare preview URLs (not manual download)
- Q: Should documentation use Package.resolved or resolve dependencies fresh? → A: Use Package.resolved - Generate docs from exact resolved versions for consistency with PR testing and reproducible builds
- Q: What should happen when production documentation deploys successfully but is functionally broken? → A: Primary prevention via PR preview validation; if issues pass PR review but break in production, use Cloudflare Pages manual rollback feature via UI
- Q: How should docs-21-dev target importing external packages be handled regarding constitutional zero-dependency rule? → A: Exempt documentation targets - Constitution allows documentation-only targets that import packages being documented (doesn't violate spirit of zero-dependency for production code)
- Q: How should the jq dependency be handled for version extraction in CI? → A: Assume jq is pre-installed on macOS-15 GitHub runners (verify assumption and document)
- Q: What happens when extracted version from Package.resolved doesn't match a valid GitHub tag? → A: Not possible - SPM package resolution ensures Package.resolved only contains versions that exist as GitHub releases/tags (no additional validation needed)
- Q: What logging detail should CI workflows capture for documentation generation? → A: Minimal logging - Standard GitHub Actions output (command executed, exit code, stdout/stderr) is sufficient

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Browse Library Documentation (Priority: P1)

As a developer evaluating or using the swift-secp256k1 library, I want to access comprehensive API documentation at docs.21.dev so I can understand available cryptographic functions, their parameters, return types, and usage examples without reading source code.

**Why this priority**: This is the core value proposition - making library APIs discoverable and understandable. Without this, developers cannot effectively use the library.

**Independent Test**: Can be fully tested by visiting docs.21.dev and verifying that all four targets (P256K, ZKP, libsecp256k1, libsecp256k1_zkp) are documented with public API signatures, descriptions, and navigation.

**Acceptance Scenarios**:

1. **Given** I am a developer researching elliptic curve cryptography, **When** I navigate to docs.21.dev, **Then** I see a landing page with links to all four library targets.
2. **Given** I want to use the ZKP functionality, **When** I click on the ZKP target documentation, **Then** I see all public types, functions, and properties with their signatures and descriptions.
3. **Given** I am reading a function's documentation, **When** I want to see its source code, **Then** I can click a link that takes me to the exact file and line in the swift-secp256k1 GitHub repository.
4. **Given** I need to find a specific API, **When** I use the documentation search, **Then** I get relevant results across all four targets.

---

### User Story 2 - Automatic Documentation Updates (Priority: P2)

As a library maintainer, I want documentation to automatically regenerate when swift-secp256k1 releases a new version, so that users always see current API information without manual intervention.

**Why this priority**: Keeps documentation synchronized with library releases, preventing outdated information from confusing users. Essential for maintenance efficiency.

**Independent Test**: Can be tested by triggering a Dependabot PR for a swift-secp256k1 version update, verifying CI generates test documentation, then confirming deployment after merge.

**Acceptance Scenarios**:

1. **Given** swift-secp256k1 releases version 0.22.0, **When** Dependabot detects the new version, **Then** a pull request is automatically created updating Package.swift.
2. **Given** a Dependabot PR updates swift-secp256k1, **When** the PR is opened, **Then** GitHub Actions automatically runs a test documentation generation to verify no breaking changes.
3. **Given** the test documentation build succeeds, **When** the PR is merged to main, **Then** final documentation is generated and deployed to docs.21.dev.
4. **Given** documentation generation fails on a PR, **When** I review the CI logs, **Then** I see clear error messages indicating what went wrong (missing symbols, incompatible flags, etc.).

---

### User Story 3 - Verify Documentation Before Merge (Priority: P3)

As a code reviewer, I want to preview generated documentation in pull requests before merging, so I can catch formatting issues, missing docs, or broken links early.

**Why this priority**: Quality assurance step that prevents broken documentation from reaching production. Lower priority than core generation but important for polish.

**Independent Test**: Can be tested by creating a test PR that updates swift-secp256k1, verifying CI generates preview docs, and confirming preview deployment URL is accessible.

**Acceptance Scenarios**:

1. **Given** a PR updates swift-secp256k1 version, **When** CI completes the test documentation build and deployment, **Then** I receive a Cloudflare preview URL in the PR comments.
2. **Given** I have a preview URL, **When** I open it in a browser, **Then** all links work, symbols are properly documented, and styling is correct.
3. **Given** the test build identifies issues, **When** I review the PR, **Then** I see a clear failure message explaining what needs fixing before merge.

---

### Edge Cases

- What happens when swift-secp256k1 removes a public API between versions? Documentation should build successfully and note deprecated/removed symbols.
- What happens if DocC generation fails due to malformed documentation comments? CI should fail the PR with clear error messages pointing to the source of the problem.
- What happens when the swift-secp256k1 repository is unavailable during source linking? Documentation should still generate but without source code links, or use cached repository data.
- What happens if Cloudflare Pages deployment fails after successful doc generation? CI should retry deployment and alert maintainers via GitHub notification inbox if retries fail.
- What happens when multiple Dependabot PRs are opened simultaneously (e.g., swift-secp256k1 + other dependencies)? Only PRs touching swift-secp256k1 should trigger documentation regeneration.

## Requirements *(mandatory)*

### Functional Requirements

**Documentation Generation**:
- **FR-001**: System MUST generate combined documentation for exactly four targets: P256K, ZKP, libsecp256k1, and libsecp256k1_zkp from the swift-secp256k1 package.
- **FR-002**: System MUST use the experimental combined documentation feature to merge all four targets into a unified documentation site.
- **FR-003**: System MUST document only public APIs (no internal or private symbols).
- **FR-004**: System MUST transform documentation for static hosting compatibility (no server-side rendering required).
- **FR-005**: System MUST link documented symbols to their source code in the swift-secp256k1 GitHub repository at https://github.com/21-DOT-DEV/swift-secp256k1.

**Hosting & Deployment**:
- **FR-006**: Documentation MUST be accessible at the docs.21.dev subdomain exclusively.
- **FR-007**: System MUST deploy to a separate Cloudflare Pages project (not part of the main 21.dev site).
- **FR-008**: Documentation site MUST be fully static (HTML, CSS, JavaScript only) with no runtime server dependencies.
- **FR-009**: System MUST configure Cloudflare Pages project to use docs.21.dev as a custom domain.
- **FR-020**: Documentation MUST be publicly accessible without authentication (no login required).

**CI/CD & Automation**:
- **FR-010**: System MUST detect Dependabot pull requests that update the swift-secp256k1 package version.
- **FR-011**: System MUST run test documentation generation on all Dependabot PRs affecting swift-secp256k1.
- **FR-012**: Test documentation builds MUST fail the PR if generation encounters errors.
- **FR-013**: System MUST generate and deploy final documentation automatically after PR merge to main branch.
- **FR-014**: CI MUST use the existing Cloudflare deployment workflow as a foundation, modified for documentation output.
- **FR-015**: System MUST preserve existing CI workflows for the main 21.dev site (no interference).
- **FR-021**: Documentation generation MUST use Package.resolved to ensure exact dependency versions match what is being tested in the PR.
- **FR-022**: Preview documentation MUST deploy to Cloudflare preview URLs (not production) with URL posted in PR comments.
- **FR-023**: Build artifacts MUST retain 1 day retention for passing between CI jobs (matching existing workflow pattern).

**Quality & Validation**:
- **FR-016**: Generated documentation MUST include navigation between all four targets.
- **FR-017**: All source code links MUST point to the correct file and line number in swift-secp256k1 repository.
- **FR-018**: Documentation MUST render correctly in modern browsers (Chrome, Firefox, Safari, Edge).
- **FR-019**: System MUST provide CI logs with clear error messages when documentation generation fails.
- **FR-024**: Preview deployments MUST be validated by reviewers before PR merge to catch broken documentation (primary prevention strategy).
- **FR-025**: Production documentation rollback MUST be available via Cloudflare Pages deployment history UI (manual rollback to previous working deployment).

**Constitutional Compliance**:
- **FR-026**: Documentation-only executable targets (e.g., docs-21-dev) MAY import external packages solely for documentation generation purposes without violating the zero-dependency principle.
- **FR-027**: Constitution MUST be updated to explicitly document the exemption for documentation targets before this feature is merged.

**CI Environment Dependencies**:
- **FR-028**: CI workflow MUST use jq for version extraction from Package.resolved (assumed pre-installed on macOS-15 runners).

**CI Observability**:
- **FR-030**: CI workflow logging MUST use standard GitHub Actions output capturing command execution, exit codes, and stdout/stderr (no enhanced logging required).

### Assumptions

- swift-secp256k1 package maintainers write documentation comments for public APIs.
- Dependabot is already configured for this repository.
- Cloudflare Pages account has capacity for an additional project.
- GitHub Actions runner has sufficient disk space for DocC output (typically 50-200MB).
- swift-secp256k1 will remain the only documented package in the near term (multi-repository support deferred to future work).
- Package.resolved file is committed to the repository and kept up-to-date by Dependabot.
- Constitution will be updated to explicitly allow documentation-only targets that import external packages for documentation generation purposes.
- jq command-line tool is pre-installed on macOS-15 GitHub Actions runners (must be verified before workflow deployment).
- Swift Package Manager resolution guarantees that versions in Package.resolved correspond to valid GitHub releases/tags (no version/tag mismatch possible under normal operation).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Documentation site loads at docs.21.dev and displays combined documentation for all four targets within 3 seconds on a broadband connection.
- **SC-002**: All public APIs from P256K, ZKP, libsecp256k1, and libsecp256k1_zkp appear in the generated documentation with complete signatures and descriptions.
- **SC-003**: Source code links navigate to the correct file and line in the swift-secp256k1 GitHub repository for 100% of documented symbols.
- **SC-004**: When swift-secp256k1 version is updated in Package.swift, documentation regenerates and deploys to docs.21.dev within 15 minutes of PR merge.
- **SC-005**: Dependabot PRs updating swift-secp256k1 trigger test documentation builds that complete within 10 minutes and report pass/fail status.
- **SC-006**: Documentation remains synchronized with swift-secp256k1 releases with zero manual intervention after initial setup.
- **SC-007**: CI failures provide error messages clear enough for a developer unfamiliar with DocC to diagnose the issue within 5 minutes.
- **SC-008**: Documentation site has a page load performance score of 90+ on Lighthouse.

## Future Considerations

**Multi-Repository Documentation**: The current solution uses a single `--source-service-base-url` which only supports one repository. When adding documentation for additional packages from different repositories, a new approach will be needed:
- Option 1: Generate separate documentation sites for each package repository.
- Option 2: Use custom DocC templates to inject per-target source linking.
- Option 3: Post-process generated HTML to rewrite source links based on target origin.

This limitation is acknowledged and accepted for the initial implementation. Solution will be designed when additional package documentation is required.

**Custom Landing Page**: Initial implementation will use DocC's default output for combined documentation. If the auto-generated landing page is insufficient (unclear navigation, missing branding, poor UX), a custom HTML landing page with branding and curated content can be added in a future iteration after CI/CD pipeline is stable.
