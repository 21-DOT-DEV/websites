name: Build Slipstream Site

on:
  workflow_call:
    inputs:
      website:
        description: 'Site name to build (e.g., 21-dev)'
        required: true
        type: string
    outputs:
      artifact-name:
        description: 'Name of the uploaded build artifact'
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    name: Build ${{ inputs.website }}
    runs-on: macos-15
    env:
      DEVELOPER_DIR: "/Applications/Xcode_16.4.app/Contents/Developer"
    outputs:
      artifact-name: ${{ inputs.website }}-build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/.cache/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: Build dependencies
        run: swift build --configuration release --target ${{ inputs.website }}
      
      - name: Run tests
        run: swift test --parallel
      
      - name: Generate site
        run: swift run ${{ inputs.website }}
      
      - name: Select environment-specific headers
        run: |
          website="${{ inputs.website }}"
          resources_dir="Resources/${website}"
          output_dir="Websites/${website}"
          
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ðŸ”’ Production build: using _headers.prod"
            header_source="${resources_dir}/_headers.prod"
          else
            echo "ðŸ”“ Preview build: using _headers.dev"
            header_source="${resources_dir}/_headers.dev"
          fi
          
          if [ ! -f "$header_source" ]; then
            echo "âŒ Error: Header file not found: $header_source"
            exit 1
          fi
          
          cp "$header_source" "${output_dir}/_headers"
          echo "âœ… Copied $header_source â†’ ${output_dir}/_headers"
      
      - name: Copy static resources
        run: |
          website="${{ inputs.website }}"
          resources_dir="Resources/${website}"
          output_dir="Websites/${website}"
          
          # Copy _redirects if exists
          if [ -f "${resources_dir}/_redirects" ]; then
            cp "${resources_dir}/_redirects" "${output_dir}/_redirects"
            echo "âœ… Copied _redirects"
          fi
          
          # Copy robots.txt if exists
          if [ -f "${resources_dir}/robots.txt" ]; then
            cp "${resources_dir}/robots.txt" "${output_dir}/robots.txt"
            echo "âœ… Copied robots.txt"
          fi
      
      - name: Compile Tailwind CSS
        run: |
          website="${{ inputs.website }}"
          config_file="Resources/${website}/tailwind.config.cjs"
          
          # Find all CSS input files using the flexible pattern
          css_files=$(find "Resources/${website}" -name "style.input.css" -path "*/static/style.input.css" 2>/dev/null || true)
          
          if [ -z "$css_files" ]; then
            echo "Error: No CSS input files found in Resources/${website}"
            echo "Expected pattern: Resources/${website}/*/static/style.input.css"
            exit 1
          fi
          
          echo "Found CSS input files:"
          echo "$css_files"
          
          # Compile each CSS file
          while IFS= read -r input_file; do
            # Extract the page path from the input file
            # e.g., Resources/21-dev/static/style.input.css -> static
            # e.g., Resources/21-dev/p256k/static/style.input.css -> p256k/static
            relative_path=$(echo "$input_file" | sed "s|Resources/${website}/||" | sed 's|/style\.input\.css$||')
            
            if [ "$relative_path" = "static" ]; then
              # Root CSS file
              output_file="Websites/${website}/static/style.css"
              echo "Compiling root CSS: $input_file -> $output_file"
            else
              # Page-specific CSS file
              output_file="Websites/${website}/${relative_path}/style.css"
              echo "Compiling page CSS: $input_file -> $output_file"
              
              # Ensure output directory exists
              mkdir -p "$(dirname "$output_file")"
            fi
            
            # Compile the CSS file with minification
            if ! swift package --disable-sandbox tailwindcss \
              --input "$input_file" \
              --output "$output_file" \
              --config "$config_file" \
              --minify; then
              echo "Error: Failed to compile $input_file"
              exit 1
            fi
            
            echo "Successfully compiled: $output_file"
          done <<< "$css_files"
      
      - name: Verify build output
        run: |
          website="${{ inputs.website }}"
          echo "Checking build output..."
          ls -la Websites/${website}/
          
          declare -a required_files=(
            "Websites/${website}/index.html"
            "Websites/${website}/_headers"
            "Websites/${website}/static/style.css"
            "Websites/${website}/sitemap.xml"
          )
          
          missing=()
          for path in "${required_files[@]}"; do
            if [ ! -f "$path" ]; then
              missing+=("$path")
            fi
          done
          
          if [ ${#missing[@]} -gt 0 ]; then
            echo "Error: Missing required build artifacts:"
            printf ' - %s\n' "${missing[@]}"
            exit 1
          fi
          
          echo "âœ… Required files present"
          echo "âœ… Build output verified successfully"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.website }}-build
          path: Websites/${{ inputs.website }}/
          retention-days: 1
