name: Build Slipstream Site

on:
  workflow_call:
    inputs:
      website:
        description: 'Site name to build (e.g., 21-dev)'
        required: true
        type: string
    outputs:
      artifact-name:
        description: 'Name of the uploaded build artifact'
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    name: Build ${{ inputs.website }}
    runs-on: macos-15
    env:
      DEVELOPER_DIR: "/Applications/Xcode_16.4.app/Contents/Developer"
    outputs:
      artifact-name: ${{ inputs.website }}-build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/.cache/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: Build dependencies
        run: swift build --configuration release --target ${{ inputs.website }}
      
      - name: Run tests
        run: swift test --parallel
      
      - name: Generate site
        run: swift run ${{ inputs.website }}
      
      - name: Compile Tailwind CSS
        run: |
          website="${{ inputs.website }}"
          echo "Compiling site-wide CSS for ${website}..."
          
          swift package --disable-sandbox tailwindcss \
            --input "Resources/${website}/static/style.input.css" \
            --output "Websites/${website}/static/style.css" \
            --config "Resources/${website}/tailwind.config.cjs" \
            --minify
          
          echo "✅ Successfully compiled CSS"
      
      - name: Verify build output
        run: |
          website="${{ inputs.website }}"
          echo "Checking build output..."
          ls -la Websites/${website}/
          
          # Verify index.html exists
          if [ ! -f "Websites/${website}/index.html" ]; then
            echo "Error: index.html not found in build output"
            exit 1
          fi
          
          # Verify site-wide CSS file exists
          if [ ! -f "Websites/${website}/static/style.css" ]; then
            echo "Error: Compiled CSS not found at Websites/${website}/static/style.css"
            exit 1
          fi
          
          echo "✅ Build output verified successfully"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.website }}-build
          path: Websites/${{ inputs.website }}/
          retention-days: 1
